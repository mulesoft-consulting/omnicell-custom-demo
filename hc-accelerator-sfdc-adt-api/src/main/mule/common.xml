<?xml version="1.0" encoding="UTF-8"?>

<mule xmlns:ee="http://www.mulesoft.org/schema/mule/ee/core" xmlns:os="http://www.mulesoft.org/schema/mule/os"
	xmlns:salesforce="http://www.mulesoft.org/schema/mule/salesforce"
	xmlns="http://www.mulesoft.org/schema/mule/core" xmlns:doc="http://www.mulesoft.org/schema/mule/documentation" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://www.mulesoft.org/schema/mule/core http://www.mulesoft.org/schema/mule/core/current/mule.xsd
http://www.mulesoft.org/schema/mule/salesforce http://www.mulesoft.org/schema/mule/salesforce/current/mule-salesforce.xsd
http://www.mulesoft.org/schema/mule/os http://www.mulesoft.org/schema/mule/os/current/mule-os.xsd
http://www.mulesoft.org/schema/mule/ee/core http://www.mulesoft.org/schema/mule/ee/core/current/mule-ee.xsd">
	<sub-flow name="common_hl7-duplicate-check" doc:id="484cfb14-da98-4c22-ac7b-71161042580b" >
		<set-variable doc:name="Set Variable sourceSystemId" doc:id="d46082c9-4248-4053-9bdb-82d51fdc3457" variableName="sourceSystemId" value='#[%dw 2.0
output application/java
var ID = message.payload.Id
var PID=message.payload.Data[ID].PID
---
(((PID."PID-03"."CX-01")[0]) default ((PID."PID-03"."CM_PAT_ID-01")[0])) default null]' />
		<set-variable value='#[%dw 2.0
output application/java
---
payload.MSH."MSH-10"]' doc:name="Set Variable messageControlNumber" doc:id="597d1a63-55a6-4f7b-84e7-6db97b52e074" variableName="messageControlNumber"/>
		<os:contains doc:name="Check if PersonAccount Record Type Id exists" doc:id="d88b4b78-8902-4de8-8b35-0abde9ea6d83" objectStore="Object_store" key="RecordType" target="contains"/>
		<choice doc:name="Check if PersonAccount Record Type Id exists" doc:id="9deed923-d578-4e32-8b6f-abfd1afc1895" >
			<when expression="#[vars.contains == true]">
				<os:retrieve doc:name="Retrieve PersonAccount RecordTypeId" doc:id="da670b20-45cf-4dfc-9f6f-1344932a1bac" key="RecordType" objectStore="Object_store" target="RecordType"/>
			</when>
			<otherwise >
				<until-successful maxRetries="${until.successful.maxretries}" doc:name="Until successfully queries " doc:id="86418218-4c19-41a6-b2a6-4d7d81b4801a" millisBetweenRetries="${until.successful.timebetween}">
					<salesforce:query doc:name="Get Person Account RecordTypeId" doc:id="66a5ce5f-7656-48b9-ac73-dccec90ff6cf" config-ref="Salesforce_Config" target="RecordType" targetValue="#[payload[0].Id]">
			<salesforce:salesforce-query><![CDATA[SELECT 
 Description, Id, Name,SobjectType FROM RecordType WHERE IsPersonType=true AND SobjectType='Account' AND Name='Person Accounts'	LIMIT 1]]></salesforce:salesforce-query>
		</salesforce:query>
				</until-successful>
				<os:store doc:name="Store PersonAccount RecordTypeId" doc:id="f8252763-0e75-4f2b-9088-ed429085745f" key="RecordType" objectStore="Object_store">
					<os:value ><![CDATA[#[vars.RecordType]]]></os:value>
				</os:store>
			</otherwise>
		</choice>
		<until-successful maxRetries="${until.successful.maxretries}" doc:name="Until query is successful" doc:id="03cd3469-961b-4e6e-a7d1-0ac252896c84" millisBetweenRetries="${until.successful.timebetween}">
			<salesforce:query doc:name="Check If Person Account Exists" doc:id="7186cbe4-ec3e-4e58-95ff-e70b240b9bba" config-ref="Salesforce_Config" target="existingPersonAccountId" targetValue="#[payload[0].Id]">
			<salesforce:salesforce-query><![CDATA[SELECT Id 
FROM Account
WHERE HealthCloudGA__SourceSystemId__c = ':sourceSystemId' LIMIT 1]]></salesforce:salesforce-query>
			<salesforce:parameters><![CDATA[#[output application/java
---
{
	"sourceSystemId" : vars.sourceSystemId
}]]]></salesforce:parameters>
		</salesforce:query>
		</until-successful>
		<choice doc:name="Check If EHR Patient Exists" doc:id="4bebcbc6-83bd-4712-bb6f-48c9e2c5027d">
			<when expression="#[vars.existingPersonAccountId != null]">
				<until-successful maxRetries="5" doc:name="Until query is successful" doc:id="2c9f2075-ecac-46d4-8291-383ae5944544" >
					<salesforce:query doc:name="Check If EHR Patient Exists" doc:id="fff8cc40-61c2-48f4-90d3-567271c066c5" config-ref="Salesforce_Config" target="existingEHRPatientId" targetValue="#[payload[0].Id]">
					<salesforce:salesforce-query><![CDATA[SELECT Id 
FROM HealthCloudGA__EhrPatient__c
WHERE HealthCloudGA__Account__c = ':personAccountId' LIMIT 1]]></salesforce:salesforce-query>
					<salesforce:parameters><![CDATA[#[output application/java
---
{
	"personAccountId" : vars.existingPersonAccountId
}]]]></salesforce:parameters>
				</salesforce:query>
				</until-successful>
			</when>
			<otherwise>
				<set-variable value="#[null]" doc:name="Set Variable existingEHRPatientId" doc:id="db614485-9268-4d10-9fc4-f33b022c2327" variableName="existingEHRPatientId" />
			</otherwise>
		</choice>
	</sub-flow>
</mule>
